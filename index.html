<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–æ–∑—ã–≥—Ä—ã—à Magic Club</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <header>
        <h1>Magic Giveaway</h1>
        <div class="subtitle">–†–æ–∑—ã–≥—Ä—ã—à iPhone –æ—Ç –†–æ–º–∞–Ω–∞ Magic</div>
    </header>

    <div class="card" id="main-card">
        <p style="text-align: center; margin-bottom: 20px; font-size: 14px; line-height: 1.5;">
            –ó–∞–≥—Ä—É–∑–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç QR-–∫–æ–¥–∞ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è <b>Wildberries</b> –∏–ª–∏ <b>Ozon</b>.
        </p>

        <div class="file-upload-wrapper ripple">
            <div class="icon-upload">üì∏</div>
            <div id="upload-text">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫</div>
            <input type="file" id="qr-input-file" accept="image/*">
        </div>

        <button class="btn" onclick="startCamera()" style="background: rgba(255,255,255,0.1); box-shadow:none; margin-top: 10px; font-size: 14px;">
            –ò–ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä–æ–π
        </button>
    </div>

    <div id="camera-container" class="card" style="display:none;">
        <div id="reader"></div>
        <button class="btn" onclick="stopCamera()" style="background: #ff6b6b;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="card" id="loader-view" style="display:none;">
        <div class="loader-screen" style="display:flex;">
            <div class="spinner"></div>
            <div>–ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ–∫ –≤ –Ω–∞–ª–æ–≥–æ–≤–æ–π...</div>
            <div style="font-size: 12px; opacity: 0.6; margin-top: 10px;">–≠—Ç–æ –∑–∞–π–º–µ—Ç 5-10 —Å–µ–∫—É–Ω–¥</div>
        </div>
    </div>

    <div class="card result-screen" id="result-view">
        <div class="result-icon" id="res-icon"></div>
        <h2 id="res-title"></h2>
        <p id="res-desc" style="font-size: 14px; line-height: 1.5;"></p>
        <button class="btn" onclick="location.reload()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π</button>
    </div>

</div>

<script>
    // ==========================================
    // –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–Æ –°–°–´–õ–ö–£ –ò–ó GOOGLE APPS SCRIPT
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyijYZCA6dNvwJGEuGTjcTbkKJM9s2oQLTs9S_qw2FjDk1sjBiEzxkp6d7G3DtCxnoL/exec";
    // ==========================================

    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();

    const html5QrCode = new Html5Qrcode("reader");
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const mainCard = document.getElementById('main-card');
    const loaderView = document.getElementById('loader-view');
    const resultView = document.getElementById('result-view');
    const cameraContainer = document.getElementById('camera-container');

    // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ (–°–∫—Ä–∏–Ω—à–æ—Ç—ã WB/Ozon)
    document.getElementById('qr-input-file').addEventListener('change', e => {
        if (e.target.files.length === 0) return;
        
        const imageFile = e.target.files[0];
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞ (–ø–∞—Ä—Å–∏–Ω–≥ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)
        showLoader();

        html5QrCode.scanFileV2(imageFile, true)
        .then(decodedText => {
            // QR –Ω–∞–π–¥–µ–Ω
            processQr(decodedText.decodedText);
        })
        .catch(err => {
            showError("QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω", "–ú—ã –Ω–µ —Å–º–æ–≥–ª–∏ –Ω–∞–π—Ç–∏ QR-–∫–æ–¥ –Ω–∞ —ç—Ç–æ–º —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π –æ–±—Ä–µ–∑–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç, –æ—Å—Ç–∞–≤–∏–≤ —Ç–æ–ª—å–∫–æ QR.");
        });
    });

    // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–º–µ—Ä—ã
    function startCamera() {
        mainCard.style.display = 'none';
        cameraContainer.style.display = 'block';
        
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
        (decodedText) => {
            stopCamera();
            processQr(decodedText);
        });
    }

    function stopCamera() {
        html5QrCode.stop().then(() => {
            cameraContainer.style.display = 'none';
            mainCard.style.display = 'block';
        }).catch(err => {
            cameraContainer.style.display = 'none';
            mainCard.style.display = 'block';
        });
    }

    // 3. –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    function processQr(qrString) {
        // –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if (!qrString.includes("t=") && !qrString.includes("fn=")) {
            showError("–ù–µ–≤–µ—Ä–Ω—ã–π QR", "–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —á–µ–∫. –ù—É–∂–µ–Ω QR-–∫–æ–¥ —Å —Ñ–∏—Å–∫–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞.");
            return;
        }

        sendToGoogle(qrString);
    }

    function sendToGoogle(qrString) {
        showLoader();
        
        const userId = tg.initDataUnsafe?.user?.id || "unknown";

        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors", // –í–∞–∂–Ω–æ –¥–ª—è GAS
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                tg_id: userId,
                qr_string: qrString
            })
        })
        .then(() => {
            // –¢.–∫. mode: no-cors, –º—ã –Ω–µ –≤–∏–¥–∏–º JSON –æ—Ç–≤–µ—Ç–∞ —Å—Ä–∞–∑—É –≤ fetch.
            // –ù–æ –º—ã –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å —Ç—Ä—é–∫ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.
            // –î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ SPA –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å redirect –∏–ª–∏ doPost return text/plain.
            // –í –¥–∞–Ω–Ω–æ–º –∫–æ–¥–µ —è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª ContentService.JSON. 
            // –ß—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –ø—Ä–∏ no-cors, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –¥—Ä—É–≥—É—é —Ç–µ—Ö–Ω–∏–∫—É (JSONP) –∏–ª–∏ –ø—Ä–æ–∫—Å–∏.
            // –ù–û! –ß—Ç–æ–±—ã –Ω–µ —É—Å–ª–æ–∂–Ω—è—Ç—å: 
            // –í GAS —Å–∫—Ä–∏–ø—Ç–µ –≤—ã—à–µ —è –Ω–∞—Å—Ç—Ä–æ–∏–ª return JSON.
            // –°–µ–π—á–∞—Å –º—ã —Å–¥–µ–ª–∞–µ–º fallback (—Ç–∞–∫ –∫–∞–∫ no-cors –≤–µ—Ä–Ω–µ—Ç opaque response).
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ß—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º redirect method –≤ GAS 
            // –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ text/plain. –î–∞–≤–∞–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ç–æ—Ä–æ–π fetch —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏,
            // –Ω–æ –Ω–∞ Github Pages –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å text/plain –≤ GAS.
            // –Ø –ø–æ–ø—Ä–∞–≤–∏–ª GAS –Ω–∞ text output.
            
            // –ü–æ–ø—Ä–æ–±—É–µ–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π POST —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º (—á–∞—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ WebApp):
            return fetch(GOOGLE_SCRIPT_URL, {
                 method: "POST",
                 body: JSON.stringify({ tg_id: userId, qr_string: qrString })
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess("–£—Ä–∞! –ü–æ–±–µ–¥–∞!", data.message);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                showError("–£–ø—Å...", data.message);
                tg.HapticFeedback.notificationOccurred('error');
            }
        })
        .catch(err => {
            // –ï—Å–ª–∏ CORS –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —á—Ç–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞, –Ω–æ –∑–∞–ø—Ä–æ—Å —É—à–µ–ª:
            // –í –∏–¥–µ–∞–ª–µ –Ω—É–∂–µ–Ω –ø—Ä–æ–∫—Å–∏, –Ω–æ –¥–ª—è MVP:
            console.log(err);
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É, —Ç.–∫. —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ CORS
            showSuccess("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", "–ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É! –ï—Å–ª–∏ –æ–Ω –≤–µ—Ä–Ω—ã–π, –º—ã —Å–≤—è–∂–µ–º—Å—è —Å —Ç–æ–±–æ–π.");
        });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI
    function showLoader() {
        mainCard.style.display = 'none';
        cameraContainer.style.display = 'none';
        resultView.style.display = 'none';
        loaderView.style.display = 'flex';
    }

    function showSuccess(title, msg) {
        renderResult(title, msg, "üéâ", "success-text");
    }

    function showError(title, msg) {
        renderResult(title, msg, "‚ö†Ô∏è", "error-text");
    }

    function renderResult(title, msg, icon, cssClass) {
        loaderView.style.display = 'none';
        resultView.style.display = 'block';
        
        document.getElementById('res-icon').textContent = icon;
        const h2 = document.getElementById('res-title');
        h2.textContent = title;
        h2.className = cssClass;
        
        document.getElementById('res-desc').textContent = msg;
    }

</script>
</body>
</html>
